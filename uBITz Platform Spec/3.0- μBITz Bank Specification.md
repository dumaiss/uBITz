# μBITz Bank Specification v1.0 (Draft)

**Status:** Draft 0.1  
**Audience:** Hardware designers, FPGA/MCU implementers, emulator authors  
**Normativity:** Sections marked “Requirements” are normative for v1.0. Examples and annexes are informative.

---

## 0. Scope and Context

### 0.1 Purpose

The **μBITz Bank** is the **memory subsystem**. It provides word-addressed RAM and ROM/Flash to the μBITz Host through a simple, static, asynchronous interface.

From the Bank’s point of view, the μBITz fabric is very small and boring:

- It sees at most **two right-aligned logical spaces**:
  - **RAM space** (selected by `/RAMSEL`)
  - **ROM space** (selected by `/ROMSEL`)
- It sees a **0-based offset** within the selected space on `A[]`.
- It sees a **read/write direction** on `R/W_`.
- It returns data on `D[]` and may stall the Host via `/READY`.

The Bank does **not** know or care about:

- CPU-visible addresses (C64 `$D000`, Apple II `$C0XX`, etc.)
- I/O space (that’s Dock’s job)
- Banking or windowing at the platform level (that’s Host/Core’s job)

### 0.2 Dependencies

This specification refines and depends on:

- **μBITz Platform Specification v1.0**  
  (overall architecture and Bank role)
- **μBITz Host Specification v1.0**  
  (address space mapper, /RAMSEL and /ROMSEL generation)
- **μBITz Dock Specification v1.0 — Part 1 (Core)**  
  (cycle semantics, `/READY` rules)

If there is any conflict, the Platform + Core specs take precedence; this Bank spec should then be updated.

### 0.3 Design Goals

The Bank spec aims to:

1. Keep the Bank **as simple as a “fake SRAM”**: address, data, a couple of selects, and a wait line.
2. Allow Hosts to use any CPU core (real 6502, Z80, 68000, RISC-V) without changing Bank hardware.
3. Limit the **off-board address width** (e.g., 18–20 bits) so Bank PCBs stay hand-solderable and CPLD-friendly.
4. Put all platform-visible banking and weirdness on the **Host**, not on Bank cards.

---

## 1. Bank Role and Non-Goals

### 1.1 Role (Summary)

A **μBITz Bank**:

- Implements **physical memory** (SRAM, DRAM, Flash, ROM, PSRAM, etc.).
- Provides up to two logical spaces:
  - RAM (read/write)
  - ROM (read, usually no write)
- Accepts a **0-based address offset** and a space select and returns/stores data.
- May stretch cycles using `/READY` to hide slow memory.

### 1.2 Non-Goals

A μBITz Bank **MUST NOT**:

- See raw CPU addresses or platform-specific maps (C64, Apple II, etc.).
- Decode I/O addresses or respond to `/IORQ`.
- Implement platform-visible “bank switching” on its own:
  - Banking is the responsibility of the μBITz Host/Core.
  - The Bank may internally multiplex multiple chips, but externally it still looks like a single contiguous RAM space and a single contiguous ROM space.

---

## 2. Electrical Interface to the Host

This section defines the **logical signals** at the Bank edge. Physical pinouts are defined by the Dock profile (Parallel/Minimal) or by a direct connector in a non-Dock build.

### 2.1 Signals

**Inputs (from Host):**

- `A[OffboardAddrWidth-1:0]`  
  0-based address **offset** within the selected space. `OffboardAddrWidth` is declared in the Bank Descriptor.
- `D[DataBusWidth-1:0]` (write data)  
  Driven by Host during writes.
- `/MREQ` – **Memory request qualifier**, active low  
  Bounds a single memory access.
- `R/W_` – Read/Write, 1 = read, 0 = write
- `/RAMSEL` – Active-low RAM space select  
- `/ROMSEL` – Active-low ROM space select  
  (Exactly one of `/RAMSEL` or `/ROMSEL` may be active for a valid memory cycle; both may be inactive when no Bank access is happening.)
- Reset (optional) – Bank reset line, profile-specific

**Outputs (to Host):**

- `D[DataBusWidth-1:0]` (read data)  
  Driven by Bank during reads; tri-stated otherwise.
- `/READY` – Active-low **ready** line  
  0 = “not ready, please wait”, 1 = “data valid / operation complete”.
- Optional status outputs (error flags, presence detect, etc.)

### 2.2 Requirements

A v1.0 Bank **MUST**:

1. Treat all addresses as **0-based offsets** within RAM or ROM space:
   - It **MUST NOT** attempt to interpret CPU-visible addresses.
2. Respond only when:
   - `/MREQ` is asserted *and* exactly one of `/RAMSEL` or `/ROMSEL` is asserted.
3. Maintain `D[]` tri-stated:
   - During reset.
   - Whenever no valid Bank cycle is in progress.
   - On cycles targeted at other devices/spaces.
4. Respect `DataBusWidth` declared by both Host and Bank:
   - For mismatched widths, the Platform rules apply (e.g., Host may perform multiple narrower accesses).

---

## 3. Bank Descriptor

Each Bank card provides a **Bank Descriptor** in an I²C EEPROM, analogous to the CPU Descriptor on the Host.

### 3.1 Storage and Address

- The descriptor **MUST** be available on the I²C bus used for Platform enumeration.
- The exact I²C address range for Banks is defined in the Platform/Dock enumeration section (e.g., `0x52..0x57`); this spec assumes that convention.

### 3.2 Mandatory Fields (v1.0 minimum)

A v1.0 Bank Descriptor **MUST** include at least:

- `SpecVersion` – Bank spec version (e.g., `0x0100` = 1.0)
- `VendorID` – Manufacturer ID
- `ProductID` – Model or board ID
- `Revision` – Hardware/firmware revision

**Capability fields:**

- `OffboardAddrWidth` (bits)  
  Number of address lines implemented (e.g., 18 ⇒ 256 Ki locations).
- `DataBusWidth` (bits)  
  8 / 16 / 32.  
  Must be compatible with Host `DataBusWidth`.
- `TotalRAMBytes`  
  Total contiguous RAM capacity exposed via `/RAMSEL` (0 if none).
- `TotalROMBytes`  
  Total contiguous ROM/Flash capacity exposed via `/ROMSEL` (0 if none).
- `AccessGranularity`  
  Byte / Word / Longword – the smallest naturally aligned access the Bank is optimized for.
- `TimingClass`  
  Encoded timing grade (e.g., “Fast”, “Medium”, “Slow”), tied to `/READY` behavior (see §4).

**Optional fields:**

- `ECCSupport` – None / Parity / ECC / Other
- `Technology` – SRAM, PSRAM, DRAM, Flash, ROM, mixed
- `TestFeatures` – Built-in self-test, pattern generator, etc.

The exact byte layout can be shared with other μBITz descriptors; the important part here is **semantics**, not bit-packing.

### 3.3 Interpretation by Host

The Host (or a Dock-side supervisor) uses the Bank Descriptor to:

- Verify compatibility with its own `AddressBusWidth` and `DataBusWidth`.
- Decide how much memory space to map (e.g., only first 128 KiB if that’s all it needs).
- Tune wait-state policies based on `TimingClass`.

---

## 4. Timing Model and `/READY`

### 4.1 Basic Behavior

From the Host’s point of view, the Bank is **asynchronous** but bounded-latency:

- Host asserts `/MREQ` + `/RAMSEL` or `/ROMSEL`, places `A[]` and `D[]` (for writes).
- Bank:
  - For writes: latches data and address, then asserts `/READY = 1` when finished.
  - For reads: drives `D[]` when data is valid and asserts `/READY = 1`.

**Requirements:**

1. For every valid memory request, the Bank **MUST**:
   - Drive `/READY` low (0) while it is not ready to complete the operation.
   - Drive `/READY` high (1) once the read data is valid or the write is safely stored.
2. The Bank **MUST** guarantee a finite worst-case latency for `/READY`:
   - This worst-case bound **MUST** be documented for each `TimingClass`.
3. The Bank **MUST NOT**:
   - Hold `/READY` low indefinitely under normal operation.
   - Change `D[]` once `/READY` is high and the Host is still in the valid part of the read cycle.

### 4.2 Back-to-Back Cycles

A v1.0 Bank **MUST** support:

- Back-to-back reads to the same or adjacent addresses at the maximum frequency implied by its `TimingClass`, **provided** the Host observes `/READY`.
- Back-to-back writes under the same conditions.

A Bank **MAY** impose additional constraints, such as:

- “No more than N consecutive reads without an idle cycle.”
- “Certain addresses (e.g., Flash erase/write) may take significantly longer.”

Any such constraints **MUST** be documented in the board’s datasheet or implementation notes.

### 4.3 DRAM and Other “Non-Static” Memories

If the Bank uses DRAM (or similar technology), it is the Bank’s responsibility to:

- Handle **all refresh logic** internally.
- Still present the Host with a **static** `/READY`-based interface:
  - The Host does not need to know when refresh is happening, only that `/READY` will be asserted when the operation is complete.
- Ensure refresh cycles do not violate the worst-case latency guarantees.

---

## 5. Banking and Mapping Hooks

### 5.1 External View

From the Host/Core’s point of view, a v1.0 Bank exposes:

- A single contiguous **RAM space** of `TotalRAMBytes` bytes, starting at offset 0, when `/RAMSEL = 0`.
- A single contiguous **ROM space** of `TotalROMBytes` bytes, starting at offset 0, when `/ROMSEL = 0`.

**Requirement:**  
The Bank **MUST** behave as if these spaces are linear, 0-based arrays of words/bytes, even if internally it has multiple chips or dies.

### 5.2 Offboard Address Width and Capacity

The `OffboardAddrWidth` field constrains how many unique locations are directly addressable from the Host:

- Maximum directly addressed locations per space:
  - `MaxLocations = 2^OffboardAddrWidth`
- For example:
  - `OffboardAddrWidth = 18` ⇒ 256 Ki locations (per space).
  - With `DataBusWidth = 8`, that’s up to 256 KiB RAM and 256 KiB ROM visible at once.

If `TotalRAMBytes` or `TotalROMBytes` exceed the capacity implied by `OffboardAddrWidth`, the Bank **MAY** internally multiplex additional memory, but:

- It **MUST NOT** expose any bank-select mechanism directly on the μBITz memory bus.
- It **MUST** still present a single contiguous logical space externally.

In practice, v1.0 designs are expected to match `TotalRAMBytes`/`TotalROMBytes` to `OffboardAddrWidth` capacity and implement any CPU-visible banking on the **Host** side.

### 5.3 Host-Side Banking

All platform-visible banking (e.g., switching 16 KiB RAM banks into `$C000–$FFFF`) is:

- Implemented by the Host’s **Address Space Mapper** using CPU-visible bank registers.
- Completely transparent to the Bank:
  - The Bank only ever sees 0-based offsets within its declared capacity.

### 5.4 Optional Configuration Interfaces

A Bank **MAY** expose **out-of-band** configuration and status (e.g., ECC settings, test modes) via:

- I²C registers next to the Bank Descriptor.
- A dedicated low-speed sideband interface.

Any such interface **MUST NOT**:

- Change externally visible address semantics (RAM/ROM offsets).
- Require special bus cycles on the μBITz memory interface.

---

## 6. Implementation Notes (Informative)

### 6.1 SRAM-Centric Banks

The simplest v1.0 Bank:

- Async SRAM for RAM space.
- Parallel NOR Flash or ROM for ROM space.
- Simple glue logic for `/RAMSEL`, `/ROMSEL`, `/MREQ`, `R/W_`, `/READY`.
- `OffboardAddrWidth` typically 16–20 bits.

This is the recommended baseline for early μBITz Bank designs.

### 6.2 DRAM-Based Banks

For larger capacities:

- Use a small FPGA/MCU/CPLD with a DRAM controller.
- Present an async-SRAM-like interface to the Host with `/READY`.
- Hide refresh and DRAM timing entirely inside the Bank.

### 6.3 Mixed RAM/Flash

Banks may choose to:

- Map RAM and Flash into separate parts of the same `/RAMSEL` or `/ROMSEL` space internally, as long as the external view is contiguous.
- Or expose RAM only and rely on the Host for ROM/boot (e.g., ROM in Host local memory).

In all cases, the Bank Descriptor must accurately reflect the externally visible capacity and type.

---

## 7. Compliance for “μBITz Bank 1.0”

A board may call itself a **μBITz Bank 1.0** if and only if:

1. It exposes a valid **Bank Descriptor** with at least the mandatory fields in §3.2.
2. It implements the **logical interface** of §2:
   - 0-based offsets in `A[]` per space.
   - `/MREQ`, `/RAMSEL`, `/ROMSEL`, `R/W_`, `D[]`, `/READY` with the described behavior.
3. It provides contiguous RAM/ROM spaces as described in §5:
   - No visible gaps or wrap-around within the advertised capacity.
4. It adheres to the **timing model** of §4 and its declared `TimingClass`.
5. It does not implement any platform-visible banking or I/O-like behavior on the μBITz memory bus.
6. It passes the μBITz Bank conformance tests defined in the test annex (pattern tests, wait-state behavior, error handling).

Conformance statements **SHOULD** include:

- `OffboardAddrWidth`
- `DataBusWidth`
- `TotalRAMBytes`, `TotalROMBytes`
- `TimingClass`
- Any special features (ECC, DRAM, PSRAM, etc.)

---
